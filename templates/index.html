<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Getsurai</title>
    <link rel="manifest" href="{{ url_for('static', filename='manifest.json') }}">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="{{ url_for('static', filename='icon.png') }}">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@700&family=Roboto+Mono:wght@500;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Roboto Mono', monospace; overflow: hidden; height: 100dvh; width: 100%; touch-action: manipulation; }
        .font-casino { font-family: 'Cinzel', serif; }
        .bg-my-turn { background: radial-gradient(circle at center, #065f46 0%, #022c22 100%); }
        .bg-wait { background: radial-gradient(circle at center, #1e293b 0%, #020617 100%); }
        
        .card-base { 
            background: linear-gradient(135deg, #ffffff 0%, #f3f4f6 100%); 
            border-radius: 8px; 
            box-shadow: 2px 2px 6px rgba(0,0,0,0.4); 
            border: 1px solid #e5e7eb; 
            transition: transform 0.1s; 
        }
        .card-w { width: 5rem; } 
        .card-h { height: 7rem; } 

        .card.selected { transform: translateY(-25px) scale(1.1) !important; z-index: 30; border-color: #facc15; box-shadow: 0 0 15px rgba(250, 204, 21, 0.9); }
        .card-back { background: repeating-linear-gradient(45deg, #b91c1c, #b91c1c 5px, #991b1b 5px, #991b1b 10px); border: 2px solid #fff; border-radius: 6px; }
        
        .hint-blue { box-shadow: 0 0 10px #3b82f6; border: 2px solid #3b82f6; }
        .card-dim { filter: brightness(0.6); }
        
        .log-area::-webkit-scrollbar { width: 3px; }
        .log-area::-webkit-scrollbar-thumb { background-color: #4b5563; }
        @keyframes floatUp { 0% {transform:translateY(0) scale(0.5);opacity:0} 20%{transform:translateY(-20px) scale(1.2);opacity:1} 100%{transform:translateY(-80px) scale(0.8);opacity:0}}
        .stamp-anim { animation: floatUp 2s ease-out forwards; pointer-events: none; }

        @keyframes spotlight { 0% { opacity: 0; } 100% { opacity: 1; } }
        @keyframes flipIn { 0% { transform: rotateY(90deg); } 100% { transform: rotateY(0); } }
        .spotlight-bg { background: radial-gradient(circle, transparent 10%, #000 90%); }
    </style>
</head>
<body class="bg-wait text-white flex flex-col">

    <div id="stamp-layer" class="absolute inset-0 pointer-events-none z-[45] overflow-hidden"></div>

    <div id="draw-overlay" class="hidden fixed inset-0 z-[60] flex items-center justify-center bg-black/80 spotlight-bg">
        <div id="draw-card-container" class="relative w-40 h-56 transition-all duration-700 transform">
            <div id="draw-card-back" class="absolute inset-0 card-back shadow-2xl"></div>
            <div id="draw-card-front" class="absolute inset-0 card-base flex flex-col items-center justify-center hidden">
                <span id="draw-rank" class="font-bold text-6xl"></span>
                <span id="draw-suit" class="text-3xl mt-2"></span>
            </div>
        </div>
    </div>

    <div id="lobby-screen" class="absolute inset-0 z-50 flex items-center justify-center bg-black/95 p-4">
        <div class="bg-gray-800 p-6 rounded-xl shadow-2xl border border-yellow-500/30 text-center max-w-md w-full">
            <h1 class="text-4xl font-casino text-yellow-500 mb-2">Getsurai</h1>
            <input type="text" id="username" placeholder="Name" class="w-full bg-gray-700 p-3 rounded mb-4 text-white">
            <div class="space-y-3">
                <button onclick="startPractice()" class="w-full bg-blue-600 hover:bg-blue-500 text-white font-bold py-3 rounded">PRACTICE (vs CPU)</button>
                <div class="flex gap-2">
                    <input type="text" id="room-id" placeholder="Room ID" class="w-2/3 bg-gray-700 p-3 rounded text-white">
                    <button onclick="joinGame()" class="w-1/3 bg-yellow-600 hover:bg-yellow-500 text-black font-bold py-3 rounded">JOIN</button>
                </div>
            </div>
        </div>
    </div>

    <div id="wait-screen" class="hidden absolute inset-0 z-40 flex flex-col items-center justify-center bg-black/90 p-4">
        <h2 class="text-2xl font-casino text-white mb-4">Waiting...</h2>
        <div id="player-list" class="flex gap-4 mb-8 flex-wrap justify-center"></div>
        <button id="btn-start" onclick="startGame()" class="bg-green-600 hover:bg-green-500 px-8 py-3 rounded font-bold hidden">START</button>
        <div class="text-gray-400 mt-4 text-sm">Room: <span id="display-room-id"></span></div>
    </div>

    <div id="game-screen" class="hidden flex-grow flex flex-row h-full w-full overflow-hidden">
        <div class="flex-grow flex flex-col relative h-full min-w-0">
            <div class="flex justify-between items-center px-3 h-10 shrink-0 bg-black/20">
                <div class="text-lg text-yellow-500 font-casino truncate">Getsurai <span id="room-display" class="text-xs text-gray-400"></span></div>
                <div class="flex gap-2 items-center">
                    <div class="bg-black/40 px-3 py-1 rounded-full text-xs text-gray-400">DECK <span id="deck-count" class="text-white font-bold">0</span></div>
                    <button onclick="document.getElementById('rule-modal').classList.remove('hidden')" class="bg-gray-700 text-white px-3 py-1 rounded text-xs hover:bg-gray-600">RULES</button>
                </div>
            </div>

            <div id="opponents-area" class="flex justify-around items-start w-full h-16 shrink-0 mt-2"></div>

            <div class="flex-grow flex flex-col items-center justify-center relative min-h-0">
                <div class="text-xs tracking-widest text-yellow-200 opacity-80 mb-1">NEXT <span id="target-rank" class="text-2xl font-casino font-bold text-white ml-2">-</span></div>
                
                <div id="field-container" class="relative w-full h-32 flex flex-col items-center justify-center">
                    <div id="field-cards" class="flex gap-2 items-center justify-center z-10"></div>
                    <div id="field-owner-label" class="mt-2 opacity-0 bg-black/50 px-3 py-0.5 rounded-full text-[10px] text-yellow-300 font-bold">Played by: -</div>
                </div>
            </div>

            <div class="w-full flex flex-col items-center pb-4 shrink-0 bg-gradient-to-t from-black/80 to-transparent relative">
                <div class="absolute right-4 -top-10 z-40">
                    <button onclick="document.getElementById('stamp-menu').classList.toggle('hidden')" class="w-10 h-10 rounded-full bg-gray-800 border border-gray-500 text-xl flex items-center justify-center shadow-lg active:scale-95">ğŸ˜Š</button>
                    <div id="stamp-menu" class="hidden absolute bottom-12 right-0 bg-gray-800 border border-gray-600 rounded p-2 grid grid-cols-4 gap-2 w-48 shadow-xl"></div>
                </div>

                <div class="flex items-center gap-3 bg-gray-900/90 border border-yellow-500/50 px-4 py-1 rounded-full mb-3 shadow-lg">
                    <span class="text-[10px] text-yellow-500 font-bold">SCORE</span>
                    <span id="my-score" class="text-base font-mono font-bold text-white">0</span>
                    <span id="parent-badge" class="hidden bg-red-600 text-[10px] px-2 py-0.5 rounded text-white font-bold">DEALER</span>
                </div>

                <div id="my-hand" class="flex justify-center -space-x-8 px-4 h-32 items-end mb-2 w-full overflow-visible"></div>

                <div class="flex justify-center gap-4 h-12 w-full px-4 max-w-md">
                    <button id="btn-play" onclick="playCards()" class="hidden w-1/2 bg-blue-600 active:bg-blue-400 text-white font-bold rounded-full shadow-lg text-lg tracking-widest border-2 border-blue-400">PLAY</button>
                    <button id="btn-pass" onclick="passTurn()" class="w-1/2 bg-gray-700 active:bg-gray-500 text-gray-300 font-bold rounded-full shadow-lg text-lg tracking-widest border border-gray-600">PASS</button>
                </div>
            </div>
        </div>

        <div class="w-24 sm:w-56 bg-gray-900 border-l border-gray-700 flex flex-col shrink-0">
            <div id="game-log" class="flex-grow p-2 overflow-y-auto log-area space-y-1.5 text-[10px] sm:text-xs font-mono text-gray-300 break-words leading-tight"></div>
        </div>
    </div>

    <div id="rule-modal" class="hidden fixed inset-0 bg-black/90 z-[70] flex items-center justify-center p-4 overflow-y-auto" onclick="this.classList.add('hidden')">
        <div class="bg-gray-800 text-gray-200 p-6 rounded-lg max-w-md w-full shadow-2xl border border-gray-600" onclick="event.stopPropagation()">
            <h2 class="text-2xl font-bold text-yellow-500 mb-4 border-b border-gray-600 pb-2">Getsurai Rules</h2>
            
            <h3 class="text-lg font-bold text-white mt-3">âš¡ åŸºæœ¬ãƒ«ãƒ¼ãƒ«</h3>
            <p class="text-sm mt-1">å ´ã«å‡ºã¦ã„ã‚‹ã‚«ãƒ¼ãƒ‰ã®ãƒ©ãƒ³ã‚¯ <span class="text-yellow-400 font-bold text-base">ã€Œ+1ã€</span> ã®ã‚«ãƒ¼ãƒ‰ã®ã¿å‡ºã›ã¾ã™ã€‚</p>
            <p class="text-xs text-gray-400">(ä¾‹: å ´ãŒ5ãªã‚‰6ã®ã¿ã€‚7ã¯å‡ºã›ãªã„)</p>

            <h3 class="text-lg font-bold text-white mt-3">ğŸƒ å½¹ã®ç¨®é¡</h3>
            <ul class="list-disc ml-5 text-sm space-y-1">
                <li><strong>Single:</strong> 1æšå‡ºã—</li>
                <li><strong>Pair:</strong> åŒã˜æ•°2æš (ä¾‹: 5,5)</li>
                <li><strong>Stairs:</strong> é€£ç¶šæ•°3æšä»¥ä¸Š (ä¾‹: 3,4,5)</li>
                <li><strong>Pair Stairs:</strong> <span class="text-green-400">New!</span> é€£ç¶šãƒšã‚¢2çµ„ä»¥ä¸Š (ä¾‹: 3,3,4,4)</li>
            </ul>
            <p class="text-xs text-gray-400 mt-1">â€»å ´ã¨åŒã˜æšæ•°ãƒ»æ§‹æˆã§ã€é–‹å§‹ãƒ©ãƒ³ã‚¯ã‚’+1ã—ã¦å‡ºã™ã€‚</p>

            <h3 class="text-lg font-bold text-white mt-3">ğŸ”¥ ç‰¹æ®Šã‚«ãƒ¼ãƒ‰</h3>
            <ul class="list-disc ml-5 text-sm space-y-1">
                <li><strong>[2]:</strong> Singleæœ€å¼·ã€‚å³åº§ã«å ´ãŒæµã‚Œã‚‹ã€‚</li>
                <li><strong>[8]:</strong> 8åˆ‡ã‚Šã€‚å«ã‚€ã¨å³åº§ã«å ´ãŒæµã‚Œã‚‹ã€‚</li>
                <li><strong>[JK]:</strong> ãƒ¯ã‚¤ãƒ«ãƒ‰ã‚«ãƒ¼ãƒ‰ã€‚å˜ä½“å‡ºã—ç¦æ­¢ã€‚</li>
                <li><strong>[A]:</strong> æ¬¡ã¯2ã—ã‹å‡ºã›ãªã„(å®Ÿè³ªãƒ‘ã‚¹)ã€‚</li>
            </ul>

            <h3 class="text-lg font-bold text-white mt-3">ğŸ’° ç‚¹æ•°è¨ˆç®—</h3>
            <ul class="list-disc ml-5 text-sm space-y-1">
                <li>å‹è€…ç·å–ã‚Š (æ•—è€…ãŒç‚¹ã‚’æ”¯æ‰•ã†)</li>
                <li>æ‰‹æœ­æ®‹ã‚Š1æšã«ã¤ã: <span class="text-red-400">-1ç‚¹</span></li>
                <li>JKæŒã¡: <span class="text-red-400">-2ç‚¹</span>/æš</li>
                <li>è¦ªãŒè² ã‘ã‚‹ã¨æ”¯æ‰•ã„ã¯ <span class="text-red-400">1.5å€</span></li>
            </ul>
        </div>
    </div>

    <div id="modal-overlay" class="hidden fixed inset-0 bg-black/95 z-50 flex flex-col items-center justify-center p-4">
        <h2 class="text-5xl font-casino text-yellow-400 mb-6 animate-pulse">FINISH!!</h2>
        <div id="modal-scores" class="w-full max-w-sm bg-gray-900 p-4 rounded mb-8 text-base"></div>
        <div class="flex gap-4 w-full max-w-sm">
            <button onclick="reqNextGame()" class="flex-1 bg-white hover:bg-gray-200 text-black font-bold py-4 rounded text-lg">NEXT GAME</button>
            <button onclick="reqResetGame()" class="flex-1 bg-red-900 hover:bg-red-800 text-white font-bold py-4 rounded text-lg">RESET</button>
        </div>
    </div>

<script>
    const socket = io();
    let currentRoom="", myName="", gameState={}, prevScores={}, selectedIndices=[];
    const SUITS={'â™ ':'â™ ','â™¥':'â™¥','â™¦':'â™¦','â™£':'â™£','JK':'ğŸ¤¡'}, STAMPS=['ğŸ‘','ğŸ‘','ğŸ˜‚','ğŸ˜­','ğŸ˜¡','ï¾Šï¾Ÿ','ã–ã‚â€¦','ï¾Œï¾ï½¼ï½¬ï½°'];

    document.addEventListener("visibilitychange", () => {
        if (document.visibilityState === 'visible' && currentRoom) {
            console.log("App active: reconnecting...");
            socket.emit('join_game', {room: currentRoom, name: myName});
        }
    });

    window.onload = () => {
        const sn=localStorage.getItem('g_n'), sr=localStorage.getItem('g_r');
        if(sn) document.getElementById('username').value=sn;
        if(sr) document.getElementById('room-id').value=sr;
        const m = document.getElementById('stamp-menu');
        STAMPS.forEach(s=>{
            const b=document.createElement('button');
            b.innerText=s; b.className="text-2xl hover:scale-110 transition";
            b.onclick=()=>{socket.emit('send_stamp',{room:currentRoom,stamp_id:s}); m.classList.add('hidden');};
            m.appendChild(b);
        });
    };

    function joinGame(){
        const n=document.getElementById('username').value||"Guest", r=document.getElementById('room-id').value;
        if(!r) return alert("Enter Room ID");
        localStorage.setItem('g_n',n); localStorage.setItem('g_r',r);
        myName=n; currentRoom=r;
        socket.emit('join_game',{room:r,name:n});
    }
    function startPractice(){ myName=document.getElementById('username').value||"Player"; socket.emit('start_practice',{name:myName}); }
    function startGame(){ socket.emit('start_game',{room:currentRoom}); }
    function playCards(){ socket.emit('play_card',{room:currentRoom,indices:selectedIndices}); selectedIndices=[]; }
    function passTurn(){ socket.emit('pass_turn',{room:currentRoom}); selectedIndices=[]; }
    function reqNextGame(){ socket.emit('next_game',{room:currentRoom}); }
    function reqResetGame(){ if(confirm("Reset?")) socket.emit('reset_game',{room:currentRoom}); }

    socket.on('player_drew', data => {
        // --- ä¿®æ­£ç®‡æ‰€: ãƒ‰ãƒ©ãƒãƒãƒƒã‚¯ãƒ•ãƒ©ã‚°ãŒãªã„å ´åˆã¯æ¼”å‡ºã‚’ã‚¹ã‚­ãƒƒãƒ— ---
        if (!data.dramatic) return;
        // -----------------------------------------------------
        
        const overlay = document.getElementById('draw-overlay');
        const container = document.getElementById('draw-card-container');
        const front = document.getElementById('draw-card-front');
        const rankSpan = document.getElementById('draw-rank');
        const suitSpan = document.getElementById('draw-suit');
        
        const r = data.card.rank;
        const s = data.card.suit;
        const rTxt = [11,12,13,14,15,99].includes(r) ? {11:'J',12:'Q',13:'K',14:'A',15:'2',99:'JK'}[r] : r;
        const isRed = ['â™¥','â™¦'].includes(s);
        
        rankSpan.innerText = rTxt;
        suitSpan.innerText = SUITS[s];
        rankSpan.className = `font-bold text-6xl leading-none ${isRed?'text-red-600':'text-gray-900'}`;
        suitSpan.className = `text-4xl mt-2 ${isRed?'text-red-600':'text-gray-900'}`;
        
        overlay.classList.remove('hidden');
        front.classList.add('hidden');
        container.style.transform = "rotateY(0deg) scale(0.8)";
        
        setTimeout(() => {
             container.style.transform = "scale(1.2)";
        }, 100);

        setTimeout(() => {
            container.style.transform = "rotateY(90deg) scale(1.2)";
            setTimeout(() => {
                front.classList.remove('hidden');
                container.style.transform = "rotateY(0deg) scale(1.5)";
            }, 300);
        }, 1200);

        setTimeout(() => {
            overlay.classList.add('hidden');
        }, 3000);
    });

    socket.on('update_state', s => {
        if(!s.game_over) s.players.forEach(p=>{ if(prevScores[p.id]===undefined||s.turn===0) {} });
        gameState=s; if(s.room_id) currentRoom=s.room_id;
        document.getElementById('lobby-screen').classList.add('hidden');
        if(!s.game_started) {
            document.getElementById('wait-screen').classList.remove('hidden');
            document.getElementById('game-screen').classList.add('hidden');
            updateLobby(s);
            s.players.forEach(p=>prevScores[p.id]=p.score);
        } else {
            document.getElementById('wait-screen').classList.add('hidden');
            document.getElementById('game-screen').classList.remove('hidden');
            renderGame(s);
        }
    });

    socket.on('receive_stamp', d => {
        const el=document.createElement('div'); el.innerText=d.stamp_id; el.className="absolute text-6xl stamp-anim z-[50]";
        let t=document.getElementById('opponents-area');
        if(d.sid===socket.id) t=document.getElementById('my-hand');
        const r=t.getBoundingClientRect();
        el.style.left=(r.left+r.width/2-30)+'px'; el.style.top=(r.top+r.height/2-30)+'px';
        document.getElementById('stamp-layer').appendChild(el);
        setTimeout(()=>el.remove(),2000);
    });

    function updateLobby(s){
        document.getElementById('display-room-id').innerText=currentRoom;
        document.getElementById('player-list').innerHTML=s.players.map(p=>`<div class="bg-gray-800 p-3 rounded text-center w-20"><div class="text-3xl">${p.is_cpu?'ğŸ¤–':'ğŸ‘¤'}</div><div class="text-xs truncate mt-1">${p.name}</div></div>`).join('');
        if(s.players.length>=2) document.getElementById('btn-start').classList.remove('hidden');
        else document.getElementById('btn-start').classList.add('hidden');
    }

    function renderGame(s){
        document.getElementById('room-display').innerText=`${currentRoom}`;
        document.getElementById('deck-count').innerText=s.deck_count;
        document.body.className = (s.turn===s.my_idx) ? 'bg-my-turn text-white flex flex-col' : 'bg-wait text-white flex flex-col';
        
        const l=document.getElementById('game-log');
        l.innerHTML=[...s.logs].reverse().map(g=>{
            const c=g.includes(myName)||g.includes("YOU")?"text-yellow-400":"text-gray-400";
            return `<div class="${c} border-b border-gray-800 pb-1 mb-1">${g.replace(" played","").replace(" passed"," pass")}</div>`;
        }).join('');
        l.scrollTop=0;

        document.getElementById('opponents-area').innerHTML=s.players.filter(p=>!p.is_me).map(p=>`
            <div class="flex flex-col items-center opacity-${s.turn===p.id?'100':'50'} scale-${s.turn===p.id?'110':'90'} transition-all">
                <div class="relative w-10 h-10 rounded-full bg-gray-700 border-2 flex items-center justify-center ${s.turn===p.id?'border-yellow-400 shadow-[0_0_10px_orange]':'border-gray-500'}">
                    <span class="text-lg">${p.is_cpu?'ğŸ¤–':'ğŸ‘¤'}</span>
                    ${s.parent===p.id?'<span class="absolute -top-2 -right-1 text-sm">ğŸ‘‘</span>':''}
                </div>
                <div class="text-[10px] truncate w-14 text-center mt-1 font-bold">${p.name}</div>
                <div class="flex -space-x-1.5 mt-1 h-6">
                    ${Array(Math.min(p.hand_count,15)).fill(0).map(()=>`<div class="w-4 h-5 bg-red-800 border border-white rounded-[2px]"></div>`).join('')}
                </div>
                <div class="text-[10px] text-gray-400 font-mono">${p.score}</div>
            </div>
        `).join('');

        document.getElementById('field-cards').innerHTML=s.field.map((c,i)=>
            `<div class="card-base card-w card-h flex flex-col items-center justify-center" style="transform:rotate(${(Math.random()-0.5)*5}deg)">
                <span class="${['â™¥','â™¦'].includes(c.suit)?'text-red-600':'text-gray-900'} font-bold text-4xl leading-none">${[11,12,13,14,15,99].includes(c.rank)?{11:'J',12:'Q',13:'K',14:'A',15:'2',99:'JK'}[c.rank]:c.rank}</span>
                <span class="${['â™¥','â™¦'].includes(c.suit)?'text-red-600':'text-gray-900'} text-xl">${SUITS[c.suit]}</span>
            </div>`
        ).join('');
        document.getElementById('field-owner-label').style.opacity = s.field.length?'1':'0';
        
        let tRankVal = null;
        let tText = "ANY";
        if(s.field.length){
            const valid = s.field.filter(c=>c.rank!==99).map(c=>c.rank).sort((a,b)=>a-b);
            const cur = valid.length ? valid[0] : 99;
            if(cur===99){ tText="FREE"; }
            else if(cur===14){ tText="2 Only"; tRankVal=15; }
            else if(cur===15){ tText="MAX"; }
            else {
                tRankVal = cur + 1;
                tText = {11:'J',12:'Q',13:'K',14:'A',15:'2',99:'JK'}[tRankVal] || tRankVal;
            }
        }
        document.getElementById('target-rank').innerText=tText;

        document.getElementById('my-score').innerText=s.my_score;
        document.getElementById('parent-badge').classList.toggle('hidden', s.parent!==s.my_idx);
        const myTurn = (s.turn===s.my_idx);
        
        document.getElementById('my-hand').innerHTML=s.my_hand.map((c,i)=>{
            const sel = selectedIndices.includes(i);
            const r = c.rank;
            
            let isPlayable = false;
            if(!s.field.length) isPlayable = true;
            else {
                if(r === 99) isPlayable = true;
                else if(tRankVal !== null && r === tRankVal) isPlayable = true;
                if(r === 15) {
                    if(s.field.length === 1) isPlayable = true;
                }
            }
            if(!myTurn) isPlayable = false;

            let cls = `card-base card-w card-h flex flex-col items-center justify-center cursor-pointer transition-all duration-200 
                       ${sel ? 'selected' : ''} 
                       ${isPlayable ? 'hint-blue' : (myTurn && s.field.length ? 'card-dim' : '')}`;

            return `<div onclick="toggle(${i})" class="${cls}" style="margin-left:-36px;z-index:${i};transform:rotate(${(i-s.my_hand.length/2)*3}deg) translateY(${sel?-25:0}px)">
                 <span class="${['â™¥','â™¦'].includes(c.suit)?'text-red-600':'text-gray-900'} font-bold text-4xl leading-none">${[11,12,13,14,15,99].includes(c.rank)?{11:'J',12:'Q',13:'K',14:'A',15:'2',99:'JK'}[c.rank]:c.rank}</span>
                 <span class="${['â™¥','â™¦'].includes(c.suit)?'text-red-600':'text-gray-900'} text-xl">${SUITS[c.suit]}</span>
            </div>`
        }).join('');

        if(myTurn){
            document.getElementById('btn-pass').classList.remove('opacity-50'); document.getElementById('btn-pass').disabled=false;
            if(selectedIndices.length) document.getElementById('btn-play').classList.remove('hidden');
            else document.getElementById('btn-play').classList.add('hidden');
        } else {
            document.getElementById('btn-play').classList.add('hidden');
            document.getElementById('btn-pass').classList.add('opacity-50'); document.getElementById('btn-pass').disabled=true;
        }

        if(s.game_over){
            document.getElementById('modal-overlay').classList.remove('hidden');
            document.getElementById('modal-scores').innerHTML=s.players.map(p=>{
                const diff=p.score-(prevScores[p.id]||0);
                return `<div class="flex justify-between py-2 border-b border-gray-700 text-white">
                            <span class="font-bold">${p.name}</span>
                            <div class="text-right">
                                <span class="text-sm ${diff>0?'text-green-400':'text-red-400'} mr-3">(${diff>0?'+':''}${diff})</span>
                                <span class="font-bold text-xl">${p.score}</span>
                            </div>
                        </div>`;
            }).join('');
            if(s.my_score-(prevScores[s.my_idx]||0) > 0) launchConfetti();
        } else {
            document.getElementById('modal-overlay').classList.add('hidden');
        }
    }

    function toggle(i){ if(gameState.turn===gameState.my_idx){ const x=selectedIndices.indexOf(i); if(x>-1)selectedIndices.splice(x,1);else selectedIndices.push(i); renderGame(gameState); }}
    function launchConfetti(){
        var end=Date.now()+3000; (function frame(){
            confetti({particleCount:5,angle:60,spread:55,origin:{x:0}}); confetti({particleCount:5,angle:120,spread:55,origin:{x:1}});
            if(Date.now()<end) requestAnimationFrame(frame);
        }());
    }
</script>
</body>
</html>
